<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Sign Up — Glashan Gardening Club</title>
    <link rel="stylesheet" href="mystyle.css">
    <style>
        /* Minimal inline tweaks so page looks good without changing mystyle.css */
        body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:20px;background:#fbfbfb}
        header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
        #logo{height:56px}
        main{max-width:720px;margin:0 auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 1px 6px rgba(0,0,0,0.06)}
        .form-row{margin-bottom:12px}
        label{display:block;margin-bottom:6px}
        input[type="text"],input[type="email"],input[type="password"],input[type="number"]{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px}
        button{padding:10px 14px;border-radius:6px;border:0;background:#2b7cff;color:#fff;cursor:pointer}
        .social-row{display:flex;gap:8px;margin-top:12px}
        .social-row button{flex:1;background:#f5f5f5;color:#111;border:1px solid #ddd}
        .userbar{display:flex;gap:8px;align-items:center}
        .userbar .button{padding:6px 10px;border-radius:6px;background:#eee;text-decoration:none;color:inherit}
        #message{margin-top:12px;padding:8px;border-radius:6px}
    </style>
</head>
<body>
    <header>
        <img id="logo" src="images/logo.png" alt="Glashan Gardening Club logo" onerror="this.style.display='none'">
        <div id="userbar" aria-live="polite"></div>
    </header>
    <main>
        <h1>Sign Up</h1>

        <form id="signupForm" class="signup-form" novalidate>
            <div class="form-row">
                <label for="name">Full name (Do Not Use Your REAL NAME!!)</label>
                <input id="name" name="name" type="text" required placeholder="Your full name">
            </div>

            <div class="form-row">
                <label for="email">Email (Use ONLY Personal Email)</label>
                <input id="email" name="email" type="email" required placeholder="you@example.com">
            </div>

            <div class="form-row">
                <label for="password">Password (Don't Reuse the Same Password)</label>
                <input id="password" name="password" type="password" minlength="8" required placeholder="At least 8 characters">
            </div>

            <div class="form-row">
                <label for="confirm">Confirm password</label>
                <input id="confirm" name="confirm" type="password" required placeholder="Repeat your password">
            </div>

            <div class="form-row">
                <label for="age">Age (optional)</label>
                <input id="age" name="age" type="number" min="1" placeholder="e.g. 12">
            </div>
            
            <div class="form-row">
                <label for="phone">Phone Number</label>
                <input id="phone" name="phone" type="tel" inputmode="tel" placeholder="(optional)">
            </div>

            <div class="form-row checkbox">
                <label for="consent">
                    <input id="consent" name="consent" type="checkbox" required>
                    I agree to the club rules and that my information may be used to contact me about events.
                </label>
            </div>

            <div class="form-row">
                <button type="submit">Sign up</button>
            </div>
        </form>

        <div id="message" class="success-message" aria-live="polite" hidden></div>

        <hr>
        <h3>Or sign up with</h3>
        <div class="social-row">
            <button id="googleSignup" type="button">Google</button>
            <button id="appleSignup" type="button">Apple</button>
            <button id="microsoftSignup" type="button">Microsoft</button>
        </div>
        <div class="social-row">
            <button id="discordSignup" type="button">Discord</button>
            <button id="twitchSignup" type="button">Twitch</button>
            <button id="spotifySignup" type="button">Spotify</button>
        </div>

        <p><a href="index.html">← Back to Home</a></p>
    </main>

    <!-- Load the clean social handlers so buttons work (placeholders) -->
    <script src="signup.clean.js"></script>

    <script>
        // userbar: show logged-in user or login/signup links (same logic as index.html)
        function escapeHtml(s) {
            return String(s).replace(/[&<>"'`]/g, function (c) {
                return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;","`":"&#96;"}[c];
            });
        }

        function renderUserBar() {
            const container = document.getElementById('userbar');
            if (!container) return;
            const raw = localStorage.getItem('ccc_current_user');
            if (raw) {
                try {
                    const user = JSON.parse(raw);
                    const name = user && user.name ? escapeHtml(user.name) : escapeHtml(user.email || '');
                    container.innerHTML = `<div class="userbar">Welcome, <strong>${name}</strong> <button id="logoutBtn">Log out</button></div>`;
                    const btn = document.getElementById('logoutBtn');
                    if (btn) btn.addEventListener('click', function () {
                        localStorage.removeItem('ccc_current_user');
                        renderUserBar();
                        const form = document.getElementById('signupForm'); if (form) form.style.display = '';
                    });
                    return;
                } catch (e) {
                    // fall through to signed-out state
                }
            }
            container.innerHTML = `<div class="userbar"><a href="login.html" class="button">Log in</a> <a href="signup.html" class="button">Sign up</a></div>`;
        }

        document.addEventListener('DOMContentLoaded', renderUserBar);

        (function () {
            const form = document.getElementById('signupForm');
            const message = document.getElementById('message');

            function showMessage(text) {
                message.hidden = false;
                message.textContent = text;
            }

            async function hashString(str) {
                try {
                    const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
                    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
                } catch (e) {
                    return btoa(str);
                }
            }

            if (form) {
                form.addEventListener('submit', async function (e) {
                    e.preventDefault();
                    // basic client-side validation
                    const name = form.name.value.trim();
                    const email = form.email.value.trim();
                    const pwd = form.password.value;
                    const confirm = form.confirm.value;
                    const consent = form.consent.checked;

                    if (!name || !email || !pwd || !confirm) {
                        showMessage('Please complete all required fields.');
                        return;
                    }

                    if (pwd.length < 6) {
                        showMessage('Password must be at least 6 characters.');
                        return;
                    }

                    if (pwd !== confirm) {
                        showMessage('Passwords do not match.');
                        return;
                    }

                    if (!consent) {
                        showMessage('You must agree to the club rules to sign up.');
                        return;
                    }

                    const safeName = name.split('\n')[0];
                    const pwHash = await hashString(pwd);

                    try {
                        const entrants = JSON.parse(localStorage.getItem('ccc_signups') || '[]');
                        entrants.push({ name: safeName, email: email, pwHash: pwHash, created: new Date().toISOString() });
                        localStorage.setItem('ccc_signups', JSON.stringify(entrants));
                    } catch (err) {
                        // ignore storage errors
                    }

                    // Save current user for userbar demo
                    localStorage.setItem('ccc_current_user', JSON.stringify({ name: safeName, email: email }));
                    renderUserBar();

                    showMessage(`Thanks, ${safeName}! We'll contact you at ${email}.`);
                    form.reset();
                    form.style.display = 'none';
                });
            }

            // Wire social buttons to the placeholder handlers loaded earlier (signup.clean.js)
            const socialIds = ['googleSignup','appleSignup','microsoftSignup','discordSignup','twitchSignup','spotifySignup'];
            socialIds.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                // Map element id to handler name (camel-case)
                const handlerMap = {
                    googleSignup: 'handleGoogleSignup',
                    appleSignup: 'handleAppleSignup',
                    microsoftSignup: 'handleMicrosoftSignup',
                    discordSignup: 'handleDiscordSignup',
                    twitchSignup: 'handleTwitchSignup',
                    spotifySignup: 'handleSpotifySignup'
                };
                const fnName = handlerMap[id];
                if (typeof window[fnName] === 'function') {
                    el.addEventListener('click', window[fnName]);
                } else {
                    el.addEventListener('click', function (e) { e.preventDefault(); alert(fnName + ' not available'); });
                }
            });
        })();
    </script>
</body>
</html>
